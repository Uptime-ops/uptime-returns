<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehance Returns Management</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <!-- DateRangePicker CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        
        .stat-card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,.15);
        }
        
        .stat-icon {
            font-size: 2rem;
            opacity: 0.8;
        }
        
        .filter-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,.08);
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,.08);
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-processed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .shared-badge {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* Sync Status Styles */
        .sync-container {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,.08);
        }
        
        .sync-progress {
            margin-top: 10px;
        }
        
        .sync-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .sync-info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .analytics-chart {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,.08);
            height: 300px;
            position: relative;
        }
        
        .analytics-chart canvas {
            max-height: 250px !important;
        }
        
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-boxes"></i> Warehance Returns Management
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showDashboard()">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showReturns()">
                            <i class="fas fa-undo"></i> Returns
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showAnalytics()">
                            <i class="fas fa-chart-line"></i> Analytics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showEmailShares()">
                            <i class="fas fa-envelope"></i> Email Shares
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                    </li>
                    <!-- Sync moved to main content area -->
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Main Container -->
    <div class="container-fluid mt-4">
        <!-- Sync Status Section -->
        <div class="sync-container">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <button class="btn btn-primary" onclick="triggerSync()" id="syncButton">
                        <i class="fas fa-sync"></i> Sync Now
                    </button>
                </div>
                <div class="col-md-6">
                    <div id="syncProgressContainer" style="display: none;">
                        <div class="progress sync-progress">
                            <div id="syncProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small id="syncProgressText" class="text-muted"></small>
                    </div>
                    <div id="syncStatusContainer">
                        <span id="syncStatusDisplay" class="text-muted">Loading sync status...</span>
                    </div>
                </div>
                <div class="col-md-3 text-end">
                    <small id="lastSyncTime" class="text-muted"></small>
                </div>
            </div>
            <div id="syncAlert" style="display: none;"></div>
        </div>
        
        <!-- Dashboard Section -->
        <div id="dashboardSection">
            <h2 class="mb-4">Dashboard Overview</h2>
            
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Total Returns</h6>
                                    <h3 class="mb-0" id="totalReturns">0</h3>
                                </div>
                                <i class="fas fa-boxes stat-icon text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Pending Returns</h6>
                                    <h3 class="mb-0" id="pendingReturns">0</h3>
                                </div>
                                <i class="fas fa-clock stat-icon text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Processed Returns</h6>
                                    <h3 class="mb-0" id="processedReturns">0</h3>
                                </div>
                                <i class="fas fa-check-circle stat-icon text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3 mb-3">
                    <div class="card stat-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Unshared Returns</h6>
                                    <h3 class="mb-0" id="unsharedReturns">0</h3>
                                </div>
                                <i class="fas fa-share-alt stat-icon text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="analytics-chart">
                        <h5>Returns This Month</h5>
                        <div style="position: relative; height: 220px;">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="analytics-chart">
                        <h5>Returns by Status</h5>
                        <div style="position: relative; height: 220px;">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Returns Section -->
        <div id="returnsSection" style="display: none;">
            <h2 class="mb-4">Returns Management</h2>
            
            <!-- Filters -->
            <div class="filter-section">
                <h5 class="mb-3">Filters</h5>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="clientFilter" class="form-label">Client</label>
                        <select class="form-select" id="clientFilter">
                            <option value="">All Clients</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="warehouseFilter" class="form-label">Warehouse</label>
                        <select class="form-select" id="warehouseFilter">
                            <option value="">All Warehouses</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="statusFilter" class="form-label">Status</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="Pending">Pending</option>
                            <option value="Processed">Processed</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <label for="dateRange" class="form-label">Date Range</label>
                        <input type="text" class="form-control" id="dateRange" placeholder="Select date range">
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="unsharedOnly">
                            <label class="form-check-label" for="unsharedOnly">
                                Show Unshared Only
                            </label>
                        </div>
                    </div>
                    
                    <div class="col-md-3 mb-3">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search by tracking number...">
                    </div>
                    
                    <div class="col-md-6 mb-3 text-end">
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                        <button class="btn btn-secondary" onclick="resetFilters()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="btn btn-success" onclick="exportReturns()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Returns Table -->
            <div class="table-container">
                <table id="returnsTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Client</th>
                            <th>Warehouse</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Tracking #</th>
                            <th>Shared</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <!-- Analytics Section -->
        <div id="analyticsSection" style="display: none;">
            <h2 class="mb-4">Analytics & Reports</h2>
            
            <div class="row">
                <div class="col-md-12">
                    <div class="analytics-chart">
                        <h5>Top Return Reasons</h5>
                        <div style="position: relative; height: 220px;">
                            <canvas id="reasonsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="analytics-chart">
                        <h5>Returns by Client</h5>
                        <div style="position: relative; height: 220px;">
                            <canvas id="clientChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="analytics-chart">
                        <h5>Returns by Warehouse</h5>
                        <div style="position: relative; height: 220px;">
                            <canvas id="warehouseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Email Shares Section -->
        <div id="emailSharesSection" style="display: none;">
            <h2 class="mb-4">Email Share History</h2>
            
            <div class="mb-3">
                <button class="btn btn-primary" onclick="showShareModal()">
                    <i class="fas fa-envelope"></i> Create New Share
                </button>
            </div>
            
            <div class="table-container">
                <table id="sharesTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Client</th>
                            <th>Date Range</th>
                            <th>Recipient</th>
                            <th>Returns Shared</th>
                            <th>Status</th>
                            <th>Sent At</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Return Details Modal -->
    <div class="modal fade" id="returnDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Return Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="returnDetailsContent">
                    <!-- Details will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Email Share Modal -->
    <div class="modal fade" id="emailShareModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Email Share</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="emailShareForm">
                        <div class="mb-3">
                            <label for="shareClient" class="form-label">Client</label>
                            <select class="form-select" id="shareClient" required>
                                <option value="">Select Client</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="shareDateFrom" class="form-label">Date From</label>
                                <input type="date" class="form-control" id="shareDateFrom" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="shareDateTo" class="form-label">Date To</label>
                                <input type="date" class="form-control" id="shareDateTo" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="shareEmail" class="form-label">Recipient Email</label>
                            <input type="email" class="form-control" id="shareEmail" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="shareSubject" class="form-label">Email Subject</label>
                            <input type="text" class="form-control" id="shareSubject">
                        </div>
                        
                        <div class="mb-3">
                            <label for="shareNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="shareNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createEmailShare()">Create Share</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Spinner -->
    <div class="loading-spinner">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
    
    <!-- Sync Status Toast -->
    <div class="sync-status">
        <div id="syncToast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">Sync Status</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="syncMessage">
                <!-- Sync message will be shown here -->
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // Global variables
        let returnsTable;
        let sharesTable;
        let currentFilters = {};
        
        // Initialize on page load
        $(document).ready(function() {
            initializeDateRangePicker();
            loadDashboard();
            loadClients();
            loadWarehouses();
            initializeTables();
            checkSyncStatus(); // Load sync status on page load
        });
        
        // Initialize date range picker
        function initializeDateRangePicker() {
            $('#dateRange').daterangepicker({
                autoUpdateInput: false,
                locale: {
                    cancelLabel: 'Clear',
                    format: 'YYYY-MM-DD'
                }
            });
            
            $('#dateRange').on('apply.daterangepicker', function(ev, picker) {
                $(this).val(picker.startDate.format('YYYY-MM-DD') + ' - ' + picker.endDate.format('YYYY-MM-DD'));
            });
            
            $('#dateRange').on('cancel.daterangepicker', function(ev, picker) {
                $(this).val('');
            });
        }
        
        // Initialize DataTables
        function initializeTables() {
            returnsTable = $('#returnsTable').DataTable({
                pageLength: 25,
                processing: true,
                serverSide: false,
                columns: [
                    { data: 'id' },
                    { data: 'client_name' },
                    { data: 'warehouse_name' },
                    { 
                        data: 'status',
                        render: function(data, type, row) {
                            let badgeClass = row.processed ? 'status-processed' : 'status-pending';
                            return `<span class="status-badge ${badgeClass}">${data}</span>`;
                        }
                    },
                    { 
                        data: 'created_at',
                        render: function(data) {
                            return moment(data).format('YYYY-MM-DD HH:mm');
                        }
                    },
                    { data: 'tracking_number' },
                    { 
                        data: 'is_shared',
                        render: function(data) {
                            return data ? 
                                '<span class="status-badge shared-badge">Shared</span>' : 
                                '<span class="badge bg-secondary">Not Shared</span>';
                        }
                    },
                    {
                        data: null,
                        render: function(data, type, row) {
                            return `
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-info" onclick="viewReturnDetails(${row.id})">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ]
            });
            
            sharesTable = $('#sharesTable').DataTable({
                pageLength: 25,
                processing: true,
                serverSide: false
            });
        }
        
        // Load dashboard data
        async function loadDashboard() {
            try {
                const response = await fetch('/api/dashboard/stats');
                const data = await response.json();
                
                $('#totalReturns').text(data.total_returns);
                $('#pendingReturns').text(data.pending_returns);
                $('#processedReturns').text(data.processed_returns);
                $('#unsharedReturns').text(data.unshared_returns);
                
                // Load charts
                loadMonthlyChart();
                loadStatusChart();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        // Load clients dropdown
        async function loadClients() {
            try {
                const response = await fetch('/api/clients');
                const clients = await response.json();
                
                const clientSelect = $('#clientFilter');
                const shareClientSelect = $('#shareClient');
                
                clients.forEach(client => {
                    clientSelect.append(`<option value="${client.id}">${client.name}</option>`);
                    shareClientSelect.append(`<option value="${client.id}">${client.name}</option>`);
                });
                
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }
        
        // Load warehouses dropdown
        async function loadWarehouses() {
            try {
                const response = await fetch('/api/warehouses');
                const warehouses = await response.json();
                
                const warehouseSelect = $('#warehouseFilter');
                
                warehouses.forEach(warehouse => {
                    warehouseSelect.append(`<option value="${warehouse.id}">${warehouse.name}</option>`);
                });
                
            } catch (error) {
                console.error('Error loading warehouses:', error);
            }
        }
        
        // Apply filters and load returns
        async function applyFilters() {
            $('.loading-spinner').show();
            
            const dateRange = $('#dateRange').val();
            let dateFrom = null;
            let dateTo = null;
            
            if (dateRange) {
                const dates = dateRange.split(' - ');
                dateFrom = dates[0];
                dateTo = dates[1];
            }
            
            // Build filters object, converting empty strings to null
            const clientId = $('#clientFilter').val();
            const warehouseId = $('#warehouseFilter').val();
            const statusVal = $('#statusFilter').val();
            const searchTerm = $('#searchInput').val();
            
            currentFilters = {
                client_id: clientId ? parseInt(clientId) : null,
                warehouse_id: warehouseId ? parseInt(warehouseId) : null,
                status: statusVal || null,
                processed: statusVal === 'Processed' ? true : statusVal === 'Pending' ? false : null,
                date_from: dateFrom,
                date_to: dateTo,
                unshared_only: $('#unsharedOnly').is(':checked'),
                search: searchTerm || null,
                page: 1,
                limit: 1000
            };
            
            try {
                const response = await fetch('/api/returns/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(currentFilters)
                });
                
                const data = await response.json();
                
                // Update table
                returnsTable.clear();
                returnsTable.rows.add(data.returns);
                returnsTable.draw();
                
            } catch (error) {
                console.error('Error loading returns:', error);
                Swal.fire('Error', 'Failed to load returns', 'error');
            } finally {
                $('.loading-spinner').hide();
            }
        }
        
        // Reset filters
        function resetFilters() {
            $('#clientFilter').val('');
            $('#warehouseFilter').val('');
            $('#statusFilter').val('');
            $('#dateRange').val('');
            $('#unsharedOnly').prop('checked', false);
            $('#searchInput').val('');
            applyFilters();
        }
        
        // View return details
        async function viewReturnDetails(returnId) {
            try {
                const response = await fetch(`/api/returns/${returnId}`);
                const data = await response.json();
                
                let itemsHtml = '';
                
                // Show note if present
                if (data.items_note) {
                    itemsHtml = `<div class="alert alert-info">${data.items_note}`;
                    if (data.order_number) {
                        itemsHtml += `<br>Order Number: <strong>${data.order_number}</strong>`;
                    }
                    itemsHtml += '</div>';
                }
                
                // Show items if present
                if (data.items && data.items.length > 0) {
                    itemsHtml += '<h6>Items:</h6><ul>';
                    data.items.forEach(item => {
                        let itemText = `<li>${item.product_name || item.product?.name || 'Unknown'} (SKU: ${item.sku || item.product?.sku || 'N/A'}) - Qty: ${item.quantity}`;
                        if (item.note) {
                            itemText += ` <small class="text-muted">[${item.note}]</small>`;
                        }
                        itemText += '</li>';
                        itemsHtml += itemText;
                    });
                    itemsHtml += '</ul>';
                } else if (!data.items_note) {
                    // Only show this if there's no note and no items
                    itemsHtml = '<div class="alert alert-warning">No return items available. The Warehance API does not provide return item details.</div>';
                }
                
                const detailsHtml = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Return ID:</strong> ${data.id}</p>
                            <p><strong>API ID:</strong> ${data.api_id || 'N/A'}</p>
                            <p><strong>Client:</strong> ${data.client_name || 'N/A'}</p>
                            <p><strong>Warehouse:</strong> ${data.warehouse_name || 'N/A'}</p>
                            <p><strong>Status:</strong> ${data.status}</p>
                            <p><strong>Processed:</strong> ${data.processed ? 'Yes' : 'No'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Created:</strong> ${moment(data.created_at).format('YYYY-MM-DD HH:mm')}</p>
                            <p><strong>Tracking Number:</strong> ${data.tracking_number || 'N/A'}</p>
                            <p><strong>Carrier:</strong> ${data.carrier || 'N/A'}</p>
                            <p><strong>Label Cost:</strong> $${data.label_cost || '0.00'}</p>
                            <p><strong>Shared:</strong> ${data.is_shared ? 'Yes' : 'No'}</p>
                        </div>
                    </div>
                    ${itemsHtml}
                    <div class="mt-3">
                        <p><strong>Warehouse Note:</strong> ${data.warehouse_note || 'N/A'}</p>
                        <p><strong>Customer Note:</strong> ${data.customer_note || 'N/A'}</p>
                    </div>
                `;
                
                $('#returnDetailsContent').html(detailsHtml);
                $('#returnDetailsModal').modal('show');
                
            } catch (error) {
                console.error('Error loading return details:', error);
                Swal.fire('Error', 'Failed to load return details', 'error');
            }
        }
        
        // Export returns
        async function exportReturns() {
            try {
                // Show loading
                Swal.fire({
                    title: 'Exporting...',
                    text: 'Please wait while we prepare your export',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Prepare filter parameters
                const filterParams = {
                    client_id: currentFilters.client_id || null,
                    status: currentFilters.status || null,
                    search: currentFilters.search || ''
                };

                // Make POST request to export endpoint
                const response = await fetch('/api/returns/export/csv', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filterParams)
                });

                if (!response.ok) {
                    throw new Error('Export failed');
                }

                // Get the CSV content
                const blob = await response.blob();
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `returns_export_${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                // Close loading and show success
                Swal.fire({
                    icon: 'success',
                    title: 'Export Complete',
                    text: 'Your CSV file has been downloaded',
                    timer: 2000,
                    showConfirmButton: false
                });
            } catch (error) {
                console.error('Export error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Export Failed',
                    text: 'Failed to export returns. Please try again.'
                });
            }
        }
        
        // Show email share modal
        function showShareModal() {
            $('#emailShareModal').modal('show');
        }
        
        // Create email share
        async function createEmailShare() {
            const shareData = {
                client_id: parseInt($('#shareClient').val()),
                date_range_start: $('#shareDateFrom').val(),
                date_range_end: $('#shareDateTo').val(),
                recipient_email: $('#shareEmail').val(),
                subject: $('#shareSubject').val(),
                notes: $('#shareNotes').val()
            };
            
            try {
                const response = await fetch('/api/email-shares/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(shareData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    Swal.fire('Success', `Email share created with ${result.total_returns_shared} returns`, 'success');
                    $('#emailShareModal').modal('hide');
                    loadEmailShares();
                } else {
                    const error = await response.json();
                    Swal.fire('Error', error.detail || 'Failed to create email share', 'error');
                }
                
            } catch (error) {
                console.error('Error creating email share:', error);
                Swal.fire('Error', 'Failed to create email share', 'error');
            }
        }
        
        // Load email shares
        async function loadEmailShares() {
            try {
                const response = await fetch('/api/email-shares/history');
                const shares = await response.json();
                
                sharesTable.clear();
                sharesTable.rows.add(shares);
                sharesTable.draw();
                
            } catch (error) {
                console.error('Error loading email shares:', error);
            }
        }
        
        // Trigger sync
        async function triggerSync() {
            const confirm = await Swal.fire({
                title: 'Sync Returns',
                text: 'This will fetch the latest returns from Warehance API. Continue?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, sync now'
            });
            
            if (confirm.isConfirmed) {
                try {
                    const response = await fetch('/api/sync/trigger', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ sync_type: 'full' })
                    });
                    
                    const result = await response.json();
                    
                    $('#syncMessage').text(result.message);
                    const toast = new bootstrap.Toast($('#syncToast')[0]);
                    toast.show();
                    
                    // Check sync status periodically
                    checkSyncStatus();
                    
                } catch (error) {
                    console.error('Error triggering sync:', error);
                    Swal.fire('Error', 'Failed to start sync', 'error');
                }
            }
        }
        
        // Check sync status
        async function checkSyncStatus() {
            try {
                const response = await fetch('/api/sync/status');
                const data = await response.json();
                
                // Update sync status display
                updateSyncStatusDisplay(data);
                
                if (data.current_sync && data.current_sync.status === 'running') {
                    $('#syncStatusDisplay').html(`
                        <small class="text-warning">
                            <i class="fas fa-spinner fa-spin"></i> Syncing... (${data.current_sync.items_synced} items)
                        </small>
                    `);
                    setTimeout(checkSyncStatus, 5000); // Check again in 5 seconds
                } else if (data.current_sync && data.current_sync.status === 'completed') {
                    $('#syncMessage').text('Sync completed successfully!');
                    loadDashboard(); // Reload dashboard data
                    applyFilters(); // Reload returns
                }
                
            } catch (error) {
                console.error('Error checking sync status:', error);
            }
        }
        
        function updateSyncStatusDisplay(data) {
            const syncDisplay = $('#syncStatusDisplay');
            
            if (data.current_sync && data.current_sync.status === 'running') {
                return; // Already handled above
            }
            
            if (data.last_sync) {
                const lastSyncDate = new Date(data.last_sync);
                const now = new Date();
                const diffMs = now - lastSyncDate;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                
                let timeAgo = '';
                if (diffMins < 1) {
                    timeAgo = 'Just now';
                } else if (diffMins < 60) {
                    timeAgo = `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
                } else if (diffHours < 24) {
                    timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                } else {
                    timeAgo = lastSyncDate.toLocaleDateString() + ' ' + lastSyncDate.toLocaleTimeString();
                }
                
                let statusIcon = '';
                let statusClass = '';
                
                if (data.last_sync_status === 'success') {
                    statusIcon = '<i class="fas fa-check-circle text-success"></i>';
                    statusClass = 'text-success';
                } else if (data.last_sync_status === 'error') {
                    statusIcon = '<i class="fas fa-times-circle text-danger"></i>';
                    statusClass = 'text-danger';
                } else {
                    statusIcon = '<i class="fas fa-clock text-muted"></i>';
                    statusClass = 'text-muted';
                }
                
                syncDisplay.html(`
                    <small class="${statusClass}">
                        ${statusIcon} Last sync: ${timeAgo}
                        ${data.last_sync_message ? `<span title="${data.last_sync_message}">(${data.current_sync.items_synced || 0} items)</span>` : ''}
                    </small>
                `);
            } else {
                syncDisplay.html('<small class="text-muted"><i class="fas fa-info-circle"></i> Never synced</small>');
            }
        }
        
        // Navigation functions
        function showDashboard() {
            hideAllSections();
            $('#dashboardSection').show();
            loadDashboard();
        }
        
        function showReturns() {
            hideAllSections();
            $('#returnsSection').show();
            if (!currentFilters.client_id) {
                applyFilters();
            }
        }
        
        function showAnalytics() {
            hideAllSections();
            $('#analyticsSection').show();
            loadAnalytics();
        }
        
        function showEmailShares() {
            hideAllSections();
            $('#emailSharesSection').show();
            loadEmailShares();
        }
        
        function hideAllSections() {
            $('#dashboardSection').hide();
            $('#returnsSection').hide();
            $('#analyticsSection').hide();
            $('#emailSharesSection').hide();
        }
        
        // Load analytics charts
        function loadAnalytics() {
            loadReturnReasonsChart();
            loadClientChart();
            loadWarehouseChart();
        }
        
        // Chart functions
        function loadMonthlyChart() {
            // Placeholder for monthly returns chart
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Returns',
                        data: [12, 19, 15, 25],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 50,
                            ticks: {
                                precision: 0,
                                stepSize: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        function loadStatusChart() {
            // Use actual data from dashboard
            const pending = parseInt($('#pendingReturns').text()) || 0;
            const processed = parseInt($('#processedReturns').text()) || 0;
            
            const ctx = document.getElementById('statusChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Processed'],
                    datasets: [{
                        data: [pending, processed],
                        backgroundColor: ['#FFC107', '#28A745']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        async function loadReturnReasonsChart() {
            try {
                const response = await fetch('/api/analytics/return-reasons');
                const data = await response.json();
                
                const ctx = document.getElementById('reasonsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.reason),
                        datasets: [{
                            label: 'Count',
                            data: data.map(d => d.count),
                            backgroundColor: 'rgba(54, 162, 235, 0.5)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 20,
                                ticks: {
                                    precision: 0,
                                    stepSize: 5
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading return reasons:', error);
            }
        }
        
        function loadClientChart() {
            // Placeholder for client chart
            const ctx = document.getElementById('clientChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Euro Brands', 'MRG Brands', 'Fast Fwd', 'Articulacy', 'Brians Sports Cards'],
                    datasets: [{
                        label: 'Returns',
                        data: [31, 30, 29, 5, 2],
                        backgroundColor: 'rgba(255, 99, 132, 0.5)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 40,
                            ticks: {
                                precision: 0,
                                stepSize: 10
                            }
                        }
                    }
                }
            });
        }
        
        function loadWarehouseChart() {
            // Placeholder for warehouse chart
            const ctx = document.getElementById('warehouseChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Warehouse 1', 'Warehouse 2'],
                    datasets: [{
                        label: 'Returns',
                        data: [50, 50],
                        backgroundColor: 'rgba(75, 192, 192, 0.5)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 40,
                            ticks: {
                                precision: 0,
                                stepSize: 10
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>